{% comment %}
  Bloque de cuestionario Retorn (versión integrada)
{% endcomment %}

<style>
  .retorn-survey-container {
    width: 100%;
    max-width: {{ block.settings.max_width }}px;
    margin: {{ block.settings.margin_top }}px auto {{ block.settings.margin_bottom }}px;
    padding: 0 20px;
    background: {{ block.settings.container_bg }};
  }

  .retorn-survey-wrapper {
    position: relative;
    width: 100%;
    min-height: {{ block.settings.min_height }}px;
    background: {{ block.settings.background_color }};
    border-radius: {{ block.settings.border_radius }}px;
    overflow: hidden;
    box-shadow: {{ block.settings.shadow }};
  }

  .retorn-survey-iframe {
    width: 100%;
    min-height: {{ block.settings.min_height }}px;
    border: none;
    display: block;
    overflow: hidden;
  }
</style>

<div class="retorn-survey-container" id="retorn-survey-{{ block.id }}">
  <div class="retorn-survey-wrapper">
    <iframe 
      id="retorn-survey-frame-{{ block.id }}"
      class="retorn-survey-iframe"
      src="{{ block.settings.survey_url }}?primary={{ block.settings.primary_color | url_encode }}&accent={{ block.settings.accent_color | url_encode }}&bg={{ block.settings.background_color | url_encode }}&radius={{ block.settings.border_radius }}"
      title="Cuestionario de Recomendación Retorn"
      loading="lazy"
      allow="clipboard-write"
      sandbox="allow-forms allow-scripts allow-same-origin allow-popups"
      scrolling="no"
    ></iframe>
  </div>
</div>

<script>
  (function() {
    const iframe = document.getElementById('retorn-survey-frame-{{ block.id }}');
    const surveyOrigin = new URL('{{ block.settings.survey_url }}').origin;
    let lastReceivedHeight = 0;
    let isAdjusting = false;

    // Escucha mensajes del iframe
    window.addEventListener('message', function(e) {
      if (!e.data || e.origin !== surveyOrigin) return;

      if (e.data.type === 'retorn-survey-height' && e.data.height) {
        // Evitar ajustes si ya estamos ajustando o si la altura no cambió significativamente
        if (isAdjusting || Math.abs(e.data.height - lastReceivedHeight) < 20) {
          return;
        }

        isAdjusting = true;
        lastReceivedHeight = e.data.height;
        iframe.style.height = e.data.height + 'px';
        
        // Reset flag después de un momento
        setTimeout(function() {
          isAdjusting = false;
        }, 500);
      }

      if (e.data.type === 'retorn-add-to-cart' && e.data.products) {
        handleAddToCart(e.data.products);
      }
    }, false);

    function handleAddToCart(products) {
      const items = products.map(p => ({
        id: p.variantId,
        quantity: p.quantity || 1
      }));
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => res.json())
      .then(data => {
        console.log('Productos agregados al carrito:', data);
        window.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
      })
      .catch(err => console.error('Error al agregar productos:', err));
    }
  })();
</script>

{% schema %}
{
  "name": "Retorn Survey",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "survey_url",
      "label": "URL del Cuestionario",
      "default": "https://retorn-app.vercel.app/public/survey"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Ancho máximo (px)",
      "min": 600,
      "max": 1400,
      "step": 50,
      "default": 1200
    },
    {
      "type": "range",
      "id": "min_height",
      "label": "Altura mínima (px)",
      "min": 400,
      "max": 1200,
      "step": 50,
      "default": 800
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Margen superior (px)",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 40
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Margen inferior (px)",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 40
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Borde redondeado (px)",
      "min": 0,
      "max": 30,
      "step": 2,
      "default": 8
    },
    {
      "type": "select",
      "id": "shadow",
      "label": "Sombra",
      "options": [
        {
          "value": "none",
          "label": "Ninguna"
        },
        {
          "value": "0 2px 8px rgba(0,0,0,0.1)",
          "label": "Suave"
        },
        {
          "value": "0 4px 16px rgba(0,0,0,0.15)",
          "label": "Media"
        },
        {
          "value": "0 8px 32px rgba(0,0,0,0.2)",
          "label": "Fuerte"
        }
      ],
      "default": "0 4px 16px rgba(0,0,0,0.15)"
    },
    {
      "type": "color",
      "id": "container_bg",
      "label": "Color de fondo contenedor",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Color primario",
      "default": "#3E3E3E"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Color de acento",
      "default": "#739f99"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo interno",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}