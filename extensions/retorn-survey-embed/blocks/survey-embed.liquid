{% comment %}
  Bloque de cuestionario Retorn (versión pantalla completa)
{% endcomment %}

<style>
  /* Oculta header y footer del theme */
  header, .shopify-section--footer {
    display: none !important;
  }

  html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    overflow: hidden !important;
  }

  .retorn-survey-fullscreen {
    position: relative;
    width: 100vw;
    height: 100vh;
    margin-left: calc(-50vw + 50%);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: {{ block.settings.container_bg }};
  }

  .retorn-survey-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
    border-radius: 0 !important;
  }
</style>

<div class="retorn-survey-fullscreen" id="retorn-survey-{{ block.id }}">
  <iframe 
    id="retorn-survey-frame-{{ block.id }}"
    class="retorn-survey-iframe"
    src="{{ block.settings.survey_url }}?primary={{ block.settings.primary_color | url_encode }}&accent={{ block.settings.accent_color | url_encode }}&bg={{ block.settings.background_color | url_encode }}&radius=0"
    title="Cuestionario de Recomendación Retorn"
    loading="lazy"
    allow="clipboard-write"
    sandbox="allow-forms allow-scripts allow-same-origin allow-popups"
  ></iframe>
</div>

<script>
  (function() {
    const iframe = document.getElementById('retorn-survey-frame-{{ block.id }}');
    const surveyOrigin = new URL('{{ block.settings.survey_url }}').origin;

    // Escucha mensajes del iframe
    window.addEventListener('message', function(e) {
      if (!e.data || e.origin !== surveyOrigin) return;

      if (e.data.type === 'retorn-survey-height' && e.data.height) {
        iframe.style.height = e.data.height + 'px';
      }

      if (e.data.type === 'retorn-survey-started') {
        iframe.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (e.data.type === 'retorn-add-to-cart' && e.data.products) {
        handleAddToCart(e.data.products);
      }
    }, false);

    function handleAddToCart(products) {
      const items = products.map(p => ({
        id: p.variantId,
        quantity: p.quantity || 1
      }));
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => res.json())
      .then(data => {
        console.log('Productos agregados al carrito:', data);
        window.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
      })
      .catch(err => console.error('Error al agregar productos:', err));
    }
  })();
</script>

{% schema %}
{
  "name": "Retorn Survey (pantalla completa)",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "survey_url",
      "label": "URL del Cuestionario",
      "default": "https://retorn-app.vercel.app/public/survey"
    },
    {
      "type": "color",
      "id": "container_bg",
      "label": "Color de fondo",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Color primario",
      "default": "#3E3E3E"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Color de acento",
      "default": "#739f99"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo interno",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}
