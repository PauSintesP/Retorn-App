{% comment %}
  Bloque de cuestionario Retorn
{% endcomment %}

<style>
  .retorn-survey-wrapper {
    width: 100%;
    background: {{ block.settings.section_bg }};
    padding: 0;
    margin: 0;
  }

  .retorn-survey-container-{{ block.id }} {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  .retorn-survey-iframe-{{ block.id }} {
    width: 100%;
    min-height: 100vw;
    border: none;
    display: block;
    background: {{ block.settings.iframe_bg }};
    transition: height 0.3s ease;
  }
</style>

<div class="retorn-survey-wrapper">
  <div class="retorn-survey-container-{{ block.id }}" {{ block.shopify_attributes }}>
    <iframe 
      id="retorn-survey-frame-{{ block.id }}"
      class="retorn-survey-iframe-{{ block.id }}"
      src="{{ block.settings.survey_url }}?primary={{ block.settings.primary_color | url_encode }}&accent={{ block.settings.accent_color | url_encode }}&bg={{ block.settings.background_color | url_encode }}"
      title="Cuestionario de Recomendación Retorn"
      loading="lazy"
      allow="clipboard-write"
      sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"
    ></iframe>
  </div>
</div>

<script>
  (function() {
    const iframe = document.getElementById('retorn-survey-frame-{{ block.id }}');
    const surveyOrigin = new URL('{{ block.settings.survey_url }}').origin;
    let lastHeight = 600;

    window.addEventListener('message', function(e) {
      if (!e.data || e.origin !== surveyOrigin) return;

      if (e.data.type === 'retorn-survey-height' && e.data.height) {
        const newHeight = Math.max(600, e.data.height);
        // Solo actualizar si cambia más de 20px para evitar flicker
        if (Math.abs(newHeight - lastHeight) > 20) {
          lastHeight = newHeight;
          iframe.style.height = newHeight + 'px';
        }
      }

      if (e.data.type === 'retorn-survey-started') {
        iframe.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (e.data.type === 'retorn-add-to-cart' && e.data.products) {
        handleAddToCart(e.data.products);
      }
    }, false);

    function handleAddToCart(products) {
      const items = products.map(p => ({
        id: p.variantId,
        quantity: p.quantity || 1
      }));
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => res.json())
      .then(data => {
        console.log('✅ Productos agregados al carrito:', data);
        window.location.href = '/cart';
      })
      .catch(err => console.error('❌ Error al agregar productos:', err));
    }
  })();
</script>

{% schema %}
{
  "name": "Cuestionario Retorn",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Configuración del cuestionario"
    },
    {
      "type": "text",
      "id": "survey_url",
      "label": "URL del Cuestionario",
      "default": "https://retorn-app.vercel.app/public/survey",
      "info": "URL donde está alojado el cuestionario"
    },
    {
      "type": "header",
      "content": "Colores"
    },
    {
      "type": "color",
      "id": "section_bg",
      "label": "Color de fondo de la sección",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "iframe_bg",
      "label": "Color de fondo del iframe",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Color primario",
      "default": "#3E3E3E"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Color de acento",
      "default": "#739f99"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo del cuestionario",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Diseño y espaciado"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 600,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Ancho máximo",
      "default": 1200
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 150,
      "step": 10,
      "unit": "px",
      "label": "Padding superior",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 150,
      "step": 10,
      "unit": "px",
      "label": "Padding inferior",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_horizontal",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Padding lateral",
      "default": 20
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Redondeo de bordes",
      "default": 8
    },
    {
      "type": "select",
      "id": "box_shadow",
      "label": "Sombra",
      "options": [
        {
          "value": "none",
          "label": "Sin sombra"
        },
        {
          "value": "0 2px 8px rgba(0,0,0,0.1)",
          "label": "Sombra ligera"
        },
        {
          "value": "0 4px 16px rgba(0,0,0,0.15)",
          "label": "Sombra media"
        },
        {
          "value": "0 8px 24px rgba(0,0,0,0.2)",
          "label": "Sombra fuerte"
        }
      ],
      "default": "0 2px 8px rgba(0,0,0,0.1)"
    }
  ]
}
{% endschema %}
